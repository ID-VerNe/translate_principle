# 🛠️ CLI 自动化翻译：实现原理与架构解析

本项目不仅是一个脚本，它将 **Translate Principle** 的“4+1 步法”沉淀为了一套可扩展的自动化流水线。本文将深入探讨其背后的架构设计。

---

## 🎨 总体工作流 (Architecture)

CLI 版本的核心是将繁琐的网页交互转化为“生产线模型”。系统支持**双向翻译**（英译中/中译英），并内置了强大的故障自愈机制。以下是标准全生命周期：

```mermaid
graph TD
    A[输入: MKV/ASS/SRT] --> B{格式预处理}
    B -->|MKV| B1[mkvmerge/mkvextract 提取]
    B -->|ASS| B2[解析转为中间 SRT]
    B -->|SRT| C[解析 SRT 块]
    
    C --> D[阶段 1: 术语提取]
    D --> D1[精校库 FlashText 毫秒级匹配]
    D --> D2[五步循环采样: LLM 全文预读]
    D2 --> D3[结果同步至方向感知的发现库]
    
    D3 --> E[阶段 2: 梯次拯救流水线]
    E --> F[直译任务: 8->6->4->2->1 弹性并发]
    F --> G[润色任务: 串行滑动窗口 + 动态上下文]
    G --> G1{拦截/失败?}
    G1 -->|是| G2[剥离上下文强力穿透]
    G1 -->|否| H[阶段 3: 后处理]
    
    H --> I[ASS 样式注入 & 智能双语分行]
    I --> J[输出: 最终特效字幕]
```

---

## 核心技术深度解析

### 1. 深度采样与双库隔离 (Segregated Discovery)
为了解决 AI 预读全文时可能遗漏术语的问题，并保护核心资产：
- **五步循环采样**：脚本分 5 轮扫描全文，每次起点偏移 1 行（如 1,6,11...; 2,7,12...），确保每一行原文都被 LLM 预读。
- **方向感知隔离**：系统会自动识别翻译方向。英译中对应 `llm_discovery.db`，中译英对应 `llm_discovery_cn.db`。这种物理隔离防止了不同语言方向的术语混杂。
- **覆盖权逻辑**：加载时，系统先加载发现库，后加载精校库（`glossary_cache.db`），利用 Python 字典覆盖机制确保你的人工校对数据拥有**绝对优先级**。

### 2. 梯次拯救引擎 (Ladder Rescue Engine)
针对 API 内容过滤器（Content Filter）频繁拦截敏感词（如医学、俚语）的问题，我们实现了一套自动弹性重试机制：
- **梯次减量**：当一个 8 行批次失败时，引擎自动降级为 `6 -> 4 -> 2 -> 1` 行进行尝试。
- **上下文剥离 (Stripping)**：在每个梯次下，如果带语境翻译连续失败，引擎会尝试“剥离上下文”发起纯净请求。这通常能穿透那些因语境误判导致的拦截。
- **动态上下文维护**：在拆分处理时，引擎会实时将已翻译的小块结果追加到 `running_context` 中，确保后续小块依然能维持语义连贯。

### 3. 全量批次滑动窗口 (Full Batch Sliding Window)
字幕翻译最大的挑战是**指代不明**。我们将上下文注入机制优化为“批次对齐”模式：

| 窗口部分 | 内容 | 作用 |
| :--- | :--- | :--- |
| **Previous Context** | **上一个批次的完整翻译结果** (8行) | 提供已确定的叙事风格和指代关系。 |
| **Current Batch** | 当前正在翻译的 8 行字幕 | 核心处理单元。 |
| **Future Context** | **下一个批次的完整原文内容** (8行) | **预知未来**，防止 AI 因为不知道后续剧情而产生逻辑冲突。 |

### 4. 并行与串行的平衡 (Parallel vs. Sequential)
- **直译阶段 (Literal)**：由于不严重依赖上下文，我们使用 `asyncio` 开启**多并发并行请求**。这是提升速度的关键，1 小时的视频通常能在 10 分钟内完成直译。
- **润色阶段 (Polish)**：必须**严格串行**。因为它依赖于“上文”的翻译结果。虽然速度稍慢，但极大地提升了文学性。

### 4. ASS 智能渲染引擎
后处理脚本不仅是简单的转换，它包含了一套精简的渲染逻辑：
- **智能分行**：自动识别原文中的换行符和中英分界，确保在播放器中，中文在上，英文在下。
- **样式注入**：从 `asshead.txt` 中读取预设样式。通过 `MarginV`（垂直边距）的精细计算，让双语字幕在屏幕上排列得错落有致。

---

## 📂 模块职责说明

- `main.py`: 总调度官，负责流程串联。
- `translate_srt_llm.py`: 翻译逻辑核心，控制进度与缓存。
- `core/translation_pipeline.py`: 定义“直译”与“润色”的底层函数。
- `core/glossary_manager.py`: 负责语料库检索与术语提取。
- `pre-process/`: 负责处理 MKVToolNix 相关的底层提取。
- `post-process/`: 负责 SRT 到 ASS 的转换与样式渲染。

---
*你可以回到 [subtitle/README.md](subtitle/README.md) 查看具体的安装与运行步骤。*
